#!dockerized.sh ruby
# frozen_string_literal: true

require "bundler/setup"

Bundler.require(:development)

# Only require the specific gems we need for OCR, not everything including Sinatra
require "json"
require "ruby_llm"
require "retryable"
require "active_support/core_ext/hash/keys"
require "active_support/core_ext/array/wrap"

require "pathname"
require_relative "../lib/server/event_ocr_service"

# Configuration
service = EventOcrService.new

# CLI argument validation
if ARGV.length != 1
  puts "Usage: #{$0} <image_path>"
  puts "Example: #{$0} ./my_image.jpg"
  exit 1
end

image_path = ARGV[0]

# Validate image file exists
unless File.exist?(image_path)
  puts "Error: Image file '#{image_path}' does not exist."
  exit 1
end

begin
  puts "Analyzing image: #{image_path}"
  puts
  result = service.analyze(image_path)
  puts "Analysis result:"
  puts "=" * 50
  pp result
  puts "=" * 50
rescue => e
  puts "Error processing image: #{e.message}"
  puts "Error details: #{e.class}"
  puts e.backtrace.join("\n")

  if e.message.include?("API_KEY")
    puts
    puts "Make sure the GEMINI_API_KEY environment variable is set."
    puts "Export GEMINI_API_KEY=<your_api_key>"
  end

  exit 1
end
