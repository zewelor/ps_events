name: Convert Images to WebP

on:
  push:
    paths:
      - 'images/inbox/**'
  workflow_dispatch:

jobs:
  convert:
    runs-on: ubuntu-latest

    permissions:
      # Give the default GITHUB_TOKEN write permission to commit and push the
      # added or changed files to the repository.
      contents: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          persist-credentials: true

      - name: Install ImageMagick
        run: |
          sudo apt-get update
          sudo apt-get install -y imagemagick webp

      - name: Convert images to WebP
        run: |
          for img in images/inbox/*; do
            [ -f "$img" ] || continue
            if [ "$(basename "$img")" = ".gitkeep" ]; then continue; fi
            output="images/$(basename "${img%.*}.webp")"
            convert "$img" -resize 900x900\> "$output"
            rm "$img"
          done

      - name: Auto-commit converted images
        uses: stefanzweifel/git-auto-commit-action@v5
        with:
          commit_message: "Convert images to WebP"
          file_pattern: "images/*.webp images/inbox/*"

  purge-history:
    needs: convert
    runs-on: ubuntu-latest
    steps:
      - name: Checkout full history
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Install git-filter-repo
        run: |
          sudo apt-get update
          sudo apt-get install -y git-filter-repo
      - name: Purge image blobs from history
        run: |
          git filter-repo --invert-paths \
            --path-glob 'images/inbox/[!.]*' \
            --path-glob 'images/**/*.{png,jpg,jpeg,gif,webp}' \
      - name: Force push cleaned history
        run: |
          git push origin --force --all
          git push origin --force --tags
