---
layout: default
title: "Adicionar um Evento"
permalink: /add_event/
---

{% if jekyll.environment == 'development' %}
  {% assign test_name        = "Test Event" %}
  {% assign test_description = "Sample description for testing form submission." %}
  {% assign test_category    = "Música" %}
  {% assign test_organizer   = "Test Organizer" %}
  {% assign test_location    = "Test Venue, Town" %}
  {% assign test_start       = "2025-05-23T10:00" %}
  {% assign test_end         = "2025-05-23T12:00" %}
  {% assign test_email       = "test@example.com" %}
  {% assign test_tel         = "+1234567890" %}
  {% assign test_price_type   = "Free" %}
  {% assign test_link1       = "https://example.com/event" %}
  {% assign test_link2       = "" %}
  {% assign test_link3       = "" %}
  {% assign test_link4       = "" %}
{% else %}
  {% assign test_name = "" %}
  {% assign test_description = "" %}
  {% assign test_category = "" %}
  {% assign test_organizer = "" %}
  {% assign test_location = "" %}
  {% assign test_start = "" %}
  {% assign test_end = "" %}
  {% assign test_email = "" %}
  {% assign test_tel = "" %}
  {% assign test_price_type = "" %}
  {% assign test_link1 = "" %}
  {% assign test_link2 = "" %}
  {% assign test_link3 = "" %}
  {% assign test_link4 = "" %}
{% endif %}

<section id="add-event" class="max-w-3xl mx-auto py-8 px-4">
  <h1 class="text-2xl md:text-3xl font-semibold mb-6">Adicionar um Novo Evento</h1>
  <form action="{{ site.env.FORM_ADD_EVENT_POST_ENDPOINT }}" method="POST" enctype="multipart/form-data" class="form-card">

    <!-- Name -->
    <div>
      <label for="name" class="form-label">
        Nome <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        name="name"
        id="name"
        value="{{ test_name }}"
        required
        maxlength="100"
        class="form-input"
      />
      <p class="form-help">Nome / Título do evento (máx. 100 caracteres)</p>
    </div>

    <!-- Description -->
    <div>
      <label for="description" class="form-label">
        Descrição <span class="text-red-500">*</span>
      </label>
      <textarea
        name="description"
        id="description"
        required
        maxlength="500"
        rows="6"
        class="form-input resize-none"
      >{{ test_description }}</textarea>
      <p class="form-help">Breve descrição (máx. 500 caracteres)</p>
    </div>

    <!-- Category -->
    <div>
      <label for="category" class="form-label">
        Categoria <span class="text-red-500">*</span>
      </label>
      <select
        name="category"
        id="category"
        required
        class="form-input"
      >
        <option value="">Selecione uma categoria</option>
        <option value="Música" {% if test_category == 'Música' %}selected{% endif %}>Música</option>
        <option value="Comida" {% if test_category == 'Comida' %}selected{% endif %}>Comida</option>
        <option value="Arte" {% if test_category == 'Arte' %}selected{% endif %}>Arte</option>
        <option value="Natureza" {% if test_category == 'Natureza' %}selected{% endif %}>Natureza</option>
        <option value="Saúde & Bem-Estar" {% if test_category == 'Saúde & Bem-Estar' %}selected{% endif %}>Saúde & Bem-Estar</option>
        <option value="Desporto" {% if test_category == 'Desporto' %}selected{% endif %}>Desporto</option>
        <option value="Aprendizagem & Workshops" {% if test_category == 'Aprendizagem & Workshops' %}selected{% endif %}>Aprendizagem & Workshops</option>
        <option value="Comunidade & Cultura" {% if test_category == 'Comunidade & Cultura' %}selected{% endif %}>Comunidade & Cultura</option>
      </select>
    </div>

    <!-- Organizer -->
    <div>
      <label for="organizer" class="form-label">
        Organizador <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        name="organizer"
        id="organizer"
        value="{{ test_organizer }}"
        required
        maxlength="100"
        class="form-input"
      />
    </div>

    <!-- Location -->
    <div>
      <label for="location" class="form-label">
        Local <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        name="location"
        id="location"
        value="{{ test_location }}"
        required
        maxlength="150"
        class="form-input"
      />
    </div>

    <!-- Dates -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Start date -->
      <div>
        <label for="start_date" class="form-label">
          Data de início <span class="text-red-500">*</span>
        </label>
        <input
          type="date"
          name="start_date"
          id="start_date"
          value="{{ test_start | date: '%Y-%m-%d' }}"
          required
          class="form-input"
        />
        <label for="start_time" class="form-label mt-2">
          Start time
        </label>
        <input
          type="time"
          name="start_time"
          id="start_time"
          value="{{ test_start | date: '%H:%M' }}"
          class="form-input"
        />
        <p class="form-help">Dates are mandatory, times are optional</p>
      </div>

      <!-- End date -->
      <div>
        <label for="end_date" class="form-label">
          End date <span class="text-red-500">*</span>
        </label>
        <input
          type="date"
          name="end_date"
          id="end_date"
          value="{{ test_end | date: '%Y-%m-%d' }}"
          required
          class="form-input"
        />
        <label for="end_time" class="form-label mt-2">
          End time
        </label>
        <input
          type="time"
          name="end_time"
          id="end_time"
          value="{{ test_end | date: '%H:%M' }}"
          class="form-input"
        />
      </div>
    </div>

    <!-- Contact info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="contact_email" class="form-label">
          Contact e-mail
        </label>
        <input
          type="email"
          name="contact_email"
          id="contact_email"
          value="{{ test_email }}"
          maxlength="100"
          class="form-input"
        />
      </div>

      <div>
        <label for="contact_tel" class="form-label">
          Contact Telephone / Whatsapp
        </label>
        <input
          type="tel"
          name="contact_tel"
          id="contact_tel"
          value="{{ test_tel }}"
          maxlength="20"
          class="form-input"
        />
      </div>
    </div>

    <!-- Price Type -->
    <div>
      <label for="price_type" class="form-label">
        Tipo de Preço
      </label>
      <select name="price_type" id="price_type" class="form-input">
        <option value="Free" {% if test_price_type == 'Free' %}selected{% endif %}>Gratuito</option>
        <option value="Paid" {% if test_price_type == 'Paid' %}selected{% endif %}>Pago</option>
        <option value="Unknown" {% if test_price_type == 'Unknown' %}selected{% endif %}>Desconhecido</option>
      </select>
      <p class="form-help">Selecione se o evento é gratuito, pago ou desconhecido</p>
    </div>

    <!-- Event Image -->
    <div>
      <label for="event_image" class="form-label">
        Event Image
      </label>
      <input
        type="file"
        name="event_image"
        id="event_image"
        accept="image/*"
        class="form-input file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"
      />
      <p class="form-help">Upload an image for your event (optional). Supported formats: JPEG, PNG, GIF, WebP, BMP, TIFF. Max size: 10MB.</p>
      <div id="image-preview" class="mt-3 hidden">
        <img id="preview-img" src="" alt="Image preview" class="max-w-xs max-h-48 rounded-lg border border-gray-200" />
        <button type="button" id="remove-image" class="mt-2 text-sm text-red-600 hover:text-red-800">Remove image</button>
      </div>
    </div>

    <!-- Links -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div>
        <label for="event_link1" class="form-label">
          Event / Social media link 1
        </label>
        <input
          type="url"
          name="event_link1"
          id="event_link1"
          value="{{ test_link1 }}"
          maxlength="200"
          placeholder="https://facebook.com/..."
          class="form-input"
        />
      </div>
      <div>
        <label for="event_link2" class="form-label">
          Event / Social media link 2
        </label>
        <input
          type="url"
          name="event_link2"
          id="event_link2"
          value="{{ test_link2 }}"
          maxlength="200"
          placeholder="https://instagram.com/..."
          class="form-input"
        />
      </div>
      <div>
        <label for="event_link3" class="form-label">
          Event / Social media link 3
        </label>
        <input
          type="url"
          name="event_link3"
          id="event_link3"
          value="{{ test_link3 }}"
          maxlength="200"
          placeholder="https://example.com"
          class="form-input"
        />
      </div>
      <div>
        <label for="event_link4" class="form-label">
          Event / Social media link 4
        </label>
        <input
          type="url"
          name="event_link4"
          id="event_link4"
          value="{{ test_link4 }}"
          maxlength="200"
          placeholder="https://example.com"
          class="form-input"
        />
      </div>
    </div>

    <!-- Submit -->
    <div>
      <button
        type="submit"
        id="submit-btn"
        class="navigation-button flex items-center justify-center"
        aria-live="polite"
      >
        <!-- Spinner icon -->
        <svg id="btn-spinner" class="h-5 w-5 text-white animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"></svg>
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <span id="btn-text">Add Event</span>
      </button>
    </div>

  </form>

  <!-- Toast notifications container -->
  <div id="toast-container" class="fixed inset-x-0 bottom-5 flex flex-col items-center space-y-3 z-50" aria-live="polite" aria-atomic="true"></div>
</section>

<!-- AJAX form submission and toast logic -->
<script>
  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('#add-event form');
    const toastContainer = document.getElementById('toast-container');
    const submitBtn = document.getElementById('submit-btn');
    const btnSpinner = document.getElementById('btn-spinner');
    const btnText = document.getElementById('btn-text');
    const imageInput = document.getElementById('event_image');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const removeImageBtn = document.getElementById('remove-image');

    // Image preview functionality
    imageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
          showToast('File size too large. Maximum size is 10MB.', 'error');
          imageInput.value = '';
          return;
        }

        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/bmp', 'image/tiff'];
        if (!allowedTypes.includes(file.type)) {
          showToast('Invalid file type. Please upload an image file.', 'error');
          imageInput.value = '';
          return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          imagePreview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        imagePreview.classList.add('hidden');
      }
    });

    // Remove image functionality
    removeImageBtn.addEventListener('click', function() {
      imageInput.value = '';
      imagePreview.classList.add('hidden');
    });

    function showToast(message, type = 'success') {
      const bg = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      const toast = document.createElement('div');
      toast.setAttribute('role', 'alert');
      toast.className = `${bg} text-white px-4 py-2 rounded shadow transition-opacity duration-500`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      // Auto-hide after 3s
      setTimeout(() => {
        toast.classList.add('opacity-0');
        toast.addEventListener('transitionend', () => toast.remove());
      }, 3000);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();
      // disable and show spinner
      submitBtn.disabled = true;
      btnSpinner.classList.remove('hidden');
      btnText.textContent = 'Submitting...';
      const data = new FormData(form);
      try {
        const response = await fetch(form.action, { method: 'POST', body: data });
        const result = await response.json();

        if (response.ok && result.status === 'ok') {
          showToast(`Event "${result.event_name}" added successfully!`);
          form.reset();
          imagePreview.classList.add('hidden'); // Hide image preview after reset
        } else {
          const errorMsg = result.message || 'Unknown error occurred';
          showToast(`Error: ${errorMsg}`, 'error');
        }
      } catch (error) {
        console.error('Submission error:', error);
        showToast('Network error. Please check your connection and try again.', 'error');
      } finally {
        // re-enable and hide spinner
        submitBtn.disabled = false;
        btnSpinner.classList.add('hidden');
        btnText.textContent = 'Add Event';
      }
    });
  });
</script>
