---
layout: default
title: "Adicionar um Evento"
permalink: /add_event/
---

{% if jekyll.environment == 'development' %}
  {% assign test_name        = "Test Event" %}
  {% assign test_description = "Sample description for testing form submission." %}
  {% assign test_category    = "Música" %}
  {% assign test_organizer   = "Test Organizer" %}
  {% assign test_location    = "Test Venue, Town" %}
  {% assign test_start       = "2025-05-23T10:00" %}
  {% assign test_end         = "2025-05-23T12:00" %}
  {% assign test_email       = "test@example.com" %}
  {% assign test_tel         = "+1234567890" %}
  {% assign test_price_type   = "Free" %}
  {% assign test_link1       = "https://www.porta33.com/porta33_porto_santo/exposicoes/content_exposicoes/eira/daniel_silvestre_porto_santo.html" %}
  {% assign test_link2       = "" %}
  {% assign test_link3       = "" %}
  {% assign test_link4       = "" %}
{% else %}
  {% assign test_name = "" %}
  {% assign test_description = "" %}
  {% assign test_category = "" %}
  {% assign test_organizer = "" %}
  {% assign test_location = "" %}
  {% assign test_start = "" %}
  {% assign test_end = "" %}
  {% assign test_email = "" %}
  {% assign test_tel = "" %}
  {% assign test_price_type = "" %}
  {% assign test_link1 = "" %}
  {% assign test_link2 = "" %}
  {% assign test_link3 = "" %}
  {% assign test_link4 = "" %}
{% endif %}

<section id="add-event" class="max-w-3xl mx-auto py-8 px-4">
  <h1 class="text-2xl md:text-3xl font-semibold mb-6">Adicionar um Novo Evento</h1>

  <!-- Google Sign-In Section - Top of page -->
  <div class="mb-6 p-6 bg-white rounded-lg shadow-lg border-b-4 border-buttons">
    <div id="google-signin-section">
      <h3 class="text-lg font-medium mb-3 text-gray-700">Iniciar sessão com o Google <span class="text-red-500">*</span></h3>
      <p class="text-sm text-gray-500 mb-4">É obrigatório iniciar sessão com o Google para submeter um evento. Isto serve para verificar que o seu email é válido e correto, garantindo que conseguimos entrar em contacto consigo sobre o seu evento. O seu email do Google será utilizado como email de contacto por defeito. Isto é também uma medida de segurança para prevenir que bots utilizem o formulário.</p>
      <div id="google-signin-button"></div>
    </div>
    <div id="google-user-info" class="hidden">
      <div class="flex items-center space-x-3">
        <div class="w-8 h-8 bg-selected-filter rounded-full flex items-center justify-center">
          <svg class="w-5 h-5 text-white" fill="currentColor" viewBox="0 0 20 20">
            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
          </svg>
        </div>
        <div>
          <p class="text-sm font-medium text-gray-700">Verificado com o Google</p>
          <p id="user-email" class="text-sm text-gray-500"></p>
        </div>
      </div>
    </div>
  </div>

  <form action="{{ site.env.FORM_ADD_EVENT_POST_ENDPOINT }}" method="POST" enctype="multipart/form-data" class="form-card">

    <!-- Hidden field for Google token -->
    <input type="hidden" name="google_token" id="google_token" value="">

    <!-- Name -->
    <div>
      <label for="name" class="form-label">
        Nome <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        name="name"
        id="name"
        value="{{ test_name }}"
        required
        maxlength="100"
        class="form-input"
      />
      <p class="form-help">Nome / Título do evento (máx. 100 caracteres)</p>
    </div>

    <!-- Description -->
    <div>
      <label for="description" class="form-label">
        Descrição <span class="text-red-500">*</span>
      </label>
      <textarea
        name="description"
        id="description"
        required
        minlength="10"
        maxlength="500"
        rows="6"
        class="form-input resize-none"
      >{{ test_description }}</textarea>
      <p class="form-help">Breve descrição (máx. 500 caracteres)</p>
    </div>

    <!-- Category -->
    <div>
      <label for="category" class="form-label">
        Categoria <span class="text-red-500">*</span>
      </label>
      <select
        name="category"
        id="category"
        required
        class="form-input"
      >
        <option value="">Selecione uma categoria</option>
        <option value="Música" {% if test_category == 'Música' %}selected{% endif %}>Música</option>
        <option value="Comida" {% if test_category == 'Comida' %}selected{% endif %}>Comida</option>
        <option value="Arte" {% if test_category == 'Arte' %}selected{% endif %}>Arte</option>
        <option value="Natureza" {% if test_category == 'Natureza' %}selected{% endif %}>Natureza</option>
        <option value="Saúde & Bem-Estar" {% if test_category == 'Saúde & Bem-Estar' %}selected{% endif %}>Saúde & Bem-Estar</option>
        <option value="Desporto" {% if test_category == 'Desporto' %}selected{% endif %}>Desporto</option>
        <option value="Aprendizagem & Workshops" {% if test_category == 'Aprendizagem & Workshops' %}selected{% endif %}>Aprendizagem & Workshops</option>
        <option value="Comunidade & Cultura" {% if test_category == 'Comunidade & Cultura' %}selected{% endif %}>Comunidade & Cultura</option>
      </select>
    </div>

    <!-- Organizer -->
    <div>
      <label for="organizer" class="form-label">
        Organizador <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        name="organizer"
        id="organizer"
        value="{{ test_organizer }}"
        required
        maxlength="100"
        class="form-input"
      />
    </div>

    <!-- Location -->
    <div>
      <label for="location" class="form-label">
        Local <span class="text-red-500">*</span>
      </label>
      <input
        type="text"
        name="location"
        id="location"
        value="{{ test_location }}"
        required
        maxlength="150"
        class="form-input"
      />
    </div>

    <!-- Dates -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <!-- Start date -->
      <div>
        <label for="start_date" class="form-label">
          Data de início <span class="text-red-500">*</span>
        </label>
        <input
          type="date"
          name="start_date"
          id="start_date"
          value="{{ test_start | date: '%Y-%m-%d' }}"
          required
          class="form-input"
        />
        <label for="start_time" class="form-label mt-2">
          Hora de início
        </label>
        <input
          type="time"
          name="start_time"
          id="start_time"
          value="{{ test_start | date: '%H:%M' }}"
          class="form-input"
        />
        <p class="form-help">As datas são obrigatórias, as horas são opcionais</p>
      </div>

      <!-- End date -->
      <div>
        <label for="end_date" class="form-label">
          Data de fim <span class="text-red-500">*</span>
        </label>
        <input
          type="date"
          name="end_date"
          id="end_date"
          value="{{ test_end | date: '%Y-%m-%d' }}"
          required
          class="form-input"
        />
        <label for="end_time" class="form-label mt-2">
          Hora de fim
        </label>
        <input
          type="time"
          name="end_time"
          id="end_time"
          value="{{ test_end | date: '%H:%M' }}"
          class="form-input"
        />
      </div>
    </div>

    <!-- Contact info -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div>
        <label for="contact_email" class="form-label">
          Email de contacto
        </label>
        <input
          type="email"
          name="contact_email"
          id="contact_email"
          value="{{ test_email }}"
          maxlength="100"
          class="form-input"
        />
        <p class="form-help">Email de contacto para o evento. Por defeito, será o seu email do Google, mas pode ser alterado se estiver a adicionar um evento para outra pessoa.</p>
      </div>

      <div>
        <label for="contact_tel" class="form-label">
          Telefone de Contacto / Whatsapp
        </label>
        <input
          type="tel"
          name="contact_tel"
          id="contact_tel"
          value="{{ test_tel }}"
          maxlength="20"
          class="form-input"
        />
      </div>
    </div>

    <!-- Price Type -->
    <div>
      <label for="price_type" class="form-label">
        Tipo de Preço
      </label>
      <select name="price_type" id="price_type" class="form-input">
        <option value="Free" {% if test_price_type == 'Free' %}selected{% endif %}>Gratuito</option>
        <option value="Paid" {% if test_price_type == 'Paid' %}selected{% endif %}>Pago</option>
        <option value="Unknown" {% if test_price_type == 'Unknown' %}selected{% endif %}>Desconhecido</option>
      </select>
      <p class="form-help">Selecione se o evento é gratuito, pago ou desconhecido</p>
    </div>

    <!-- Event Image -->
    <div>
      <label for="event_image" class="form-label">
        Imagem do Evento
      </label>
      <input
        type="file"
        name="event_image"
        id="event_image"
        accept="image/*"
        class="form-input file-input-button"
      />
      <p class="form-help">Carregue uma imagem para o seu evento (opcional). Formatos suportados: JPEG, PNG, GIF, WebP, BMP, TIFF. Tamanho máximo: 10MB.</p>
      <div id="image-preview" class="mt-3 hidden">
        <img id="preview-img" src="" alt="Image preview" class="max-w-xs max-h-48 rounded-lg border border-gray-200" />
        <button type="button" id="remove-image" class="mt-2 text-sm text-red-600 hover:text-red-800">Remover imagem</button>
      </div>
    </div>

    <!-- Links -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div>
        <label for="event_link1" class="form-label">
          Link do evento / redes sociais 1
        </label>
        <input
          type="url"
          name="event_link1"
          id="event_link1"
          value="{{ test_link1 }}"
          maxlength="200"
          placeholder="https://facebook.com/..."
          class="form-input"
        />
      </div>
      <div>
        <label for="event_link2" class="form-label">
          Link do evento / redes sociais 2
        </label>
        <input
          type="url"
          name="event_link2"
          id="event_link2"
          value="{{ test_link2 }}"
          maxlength="200"
          placeholder="https://instagram.com/..."
          class="form-input"
        />
      </div>
      <div>
        <label for="event_link3" class="form-label">
          Link do evento / redes sociais 3
        </label>
        <input
          type="url"
          name="event_link3"
          id="event_link3"
          value="{{ test_link3 }}"
          maxlength="200"
          placeholder="https://example.com"
          class="form-input"
        />
      </div>
      <div>
        <label for="event_link4" class="form-label">
          Link do evento / redes sociais 4
        </label>
        <input
          type="url"
          name="event_link4"
          id="event_link4"
          value="{{ test_link4 }}"
          maxlength="200"
          placeholder="https://example.com"
          class="form-input"
        />
      </div>
    </div>

    <!-- Responsibility Declaration -->
    <div class="our-section">
      <h3 class="text-lg font-medium mb-3 text-gray-700">Declaração de responsabilidade</h3>
      <p class="text-sm text-gray-600 mb-4">
        Confirmo que as informações fornecidas são verdadeiras e corretas, segundo o meu melhor conhecimento. Comprometo-me a mantê-las atualizadas e a solicitar quaisquer correções ou alterações, se necessário, através do e-mail pxopulse@gmail.com.
      </p>
      <div class="flex items-start space-x-3">
        <input
          type="checkbox"
          id="responsibility_agreement"
          name="responsibility_agreement"
          required
          {% if jekyll.environment == 'development' %}checked{% endif %}
          class="mt-1 w-4 h-4 text-selected-filter bg-white border-gray-300 rounded focus:ring-selected-filter focus:ring-2"
        />
        <label for="responsibility_agreement" class="text-sm text-gray-700">
          Li e concordo com os termos acima. <span class="text-red-500">*</span>
        </label>
      </div>
    </div>

    <!-- Submit -->
    <div>
      <button
        type="submit"
        id="submit-btn"
        class="navigation-button flex items-center justify-center"
        aria-live="polite"
      >
        <!-- Spinner icon -->
        <svg id="btn-spinner" class="h-5 w-5 text-white animate-spin hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"></svg>
          <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
          <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8v8z"></path>
        </svg>
        <span id="btn-text">Adicionar Evento</span>
      </button>
    </div>

  </form>

  <!-- Toast notifications container -->
  <div id="toast-container" class="fixed inset-x-0 bottom-5 flex flex-col items-center space-y-3 z-50" aria-live="polite" aria-atomic="true"></div>
</section>

<!-- Google Sign-In Library -->
<script src="https://accounts.google.com/gsi/client" async defer></script>

<!-- AJAX form submission and toast logic -->
<script>
  let googleCredential = null;

  document.addEventListener('DOMContentLoaded', () => {
    const form = document.querySelector('#add-event form');
    const toastContainer = document.getElementById('toast-container');
    const submitBtn = document.getElementById('submit-btn');
    const btnSpinner = document.getElementById('btn-spinner');
    const btnText = document.getElementById('btn-text');
    const imageInput = document.getElementById('event_image');
    const imagePreview = document.getElementById('image-preview');
    const previewImg = document.getElementById('preview-img');
    const removeImageBtn = document.getElementById('remove-image');
    const contactEmailInput = document.getElementById('contact_email');
    const googleTokenInput = document.getElementById('google_token');

    // Google Sign-In elements
    const googleSigninSection = document.getElementById('google-signin-section');
    const googleUserInfo = document.getElementById('google-user-info');
    const userEmailDisplay = document.getElementById('user-email');

    // Initialize Google Sign-In
    function initializeGoogleSignIn() {
      if (typeof google !== 'undefined') {
        google.accounts.id.initialize({
          client_id: '730968670456-4kvre8am1isuqe3dbmdqs8845ntog6cq.apps.googleusercontent.com',
          callback: handleGoogleSignIn
        });

        google.accounts.id.renderButton(
          document.getElementById('google-signin-button'),
          {
            type: 'standard',
            theme: 'outline',
            size: 'large',
            text: 'signin_with',
            shape: 'rectangular',
            logo_alignment: 'left',
            locale: 'pt-PT'
          }
        );
      } else {
        setTimeout(initializeGoogleSignIn, 100);
      }
    }

    // Handle Google Sign-In response
    function handleGoogleSignIn(response) {
      googleCredential = response.credential;

      try {
        // Decode the JWT payload to get user info (client-side only for display)
        const payload = JSON.parse(atob(response.credential.split('.')[1]));

        // Update UI
        userEmailDisplay.textContent = payload.email;
        googleSigninSection.classList.add('hidden');
        googleUserInfo.classList.remove('hidden');

        // Set the token for form submission
        googleTokenInput.value = response.credential;

        // Auto-fill contact email with Google email (but allow editing)
        contactEmailInput.value = payload.email;
        contactEmailInput.removeAttribute('readonly');

        showToast(`Verificado com o Google como ${payload.email}`);
      } catch (error) {
        console.error('Error processing Google sign-in:', error);
        showToast('Erro ao processar o início de sessão', 'error');
      }
    }

    // Initialize Google Sign-In when page loads
    initializeGoogleSignIn();

    // Image preview functionality
    imageInput.addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (file) {
        // Validate file size (10MB)
        if (file.size > 10 * 1024 * 1024) {
          showToast('Tamanho do ficheiro muito grande. Tamanho máximo é 10MB.', 'error');
          imageInput.value = '';
          return;
        }

        // Validate file type
        const allowedTypes = ['image/jpeg', 'image/jpg', 'image/png', 'image/gif', 'image/webp', 'image/bmp', 'image/tiff'];
        if (!allowedTypes.includes(file.type)) {
          showToast('Tipo de ficheiro inválido. Por favor, carregue um ficheiro de imagem.', 'error');
          imageInput.value = '';
          return;
        }

        // Show preview
        const reader = new FileReader();
        reader.onload = function(e) {
          previewImg.src = e.target.result;
          imagePreview.classList.remove('hidden');
        };
        reader.readAsDataURL(file);
      } else {
        imagePreview.classList.add('hidden');
      }
    });

    // Remove image functionality
    removeImageBtn.addEventListener('click', function() {
      imageInput.value = '';
      imagePreview.classList.add('hidden');
    });

    function showToast(message, type = 'success') {
      const bg = type === 'success' ? 'bg-green-500' : 'bg-red-500';
      const toast = document.createElement('div');
      toast.setAttribute('role', 'alert');
      toast.className = `${bg} text-white px-4 py-2 rounded shadow transition-opacity duration-500`;
      toast.textContent = message;
      toastContainer.appendChild(toast);
      // Auto-hide after 3s
      setTimeout(() => {
        toast.classList.add('opacity-0');
        toast.addEventListener('transitionend', () => toast.remove());
      }, 3000);
    }

    form.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Check if user is authenticated with Google
      if (!googleCredential || !googleTokenInput.value) {
        showToast('É obrigatório iniciar sessão com o Google antes de submeter um evento.', 'error');
        return;
      }

      // disable and show spinner
      submitBtn.disabled = true;
      btnSpinner.classList.remove('hidden');
      btnText.textContent = 'A submeter...';
      const data = new FormData(form);
      try {
        const response = await fetch(form.action, { method: 'POST', body: data });

        if (!response.ok) {
          let errorMsg = `HTTP ${response.status}`;
          try {
            const result = await response.json();
            errorMsg = result.message || errorMsg;
          } catch (parseError) {
            errorMsg += ` - ${response.statusText}`;
          }
          showToast(`Erro do servidor: ${errorMsg}`, 'error');
          return;
        }

        const result = await response.json();
        if (result.status === 'ok') {
          showToast(`Evento "${result.event_name}" adicionado com sucesso!`);
          form.reset();
          imagePreview.classList.add('hidden'); // Hide image preview after reset
        } else {
          const errorMsg = result.message || 'Ocorreu um erro desconhecido';
          showToast(`Erro: ${errorMsg}`, 'error');
        }
      } catch (error) {
        console.error('Submission error:', error);
        let errorMsg = 'Erro de rede';

        // Add file info if image is attached
        const imageFile = imageInput.files[0];
        const fileInfo = imageFile ? ` (Com imagem: ${imageFile.name}, ${(imageFile.size/1024/1024).toFixed(1)}MB)` : '';

        if (error.name === 'TypeError' && error.message.includes('fetch')) {
          errorMsg += ' - Não foi possível conectar ao servidor';
        } else if (error.name === 'SyntaxError') {
          errorMsg += ' - Resposta inválida do servidor';
        } else if (error.name === 'AbortError') {
          errorMsg += ' - Timeout (demorou muito tempo)';
        } else if (error.message) {
          errorMsg += ` - ${error.name}: ${error.message}`;
        }

        showToast(`${errorMsg}${fileInfo}. Verifique a ligação e tente novamente.`, 'error');
      } finally {
        // re-enable and hide spinner
        submitBtn.disabled = false;
        btnSpinner.classList.add('hidden');
        btnText.textContent = 'Adicionar Evento';
      }
    });
  });
</script>
